    const srvMasterData = await esi.connect.to("LocalService.MasterDataService");
    const oModifiableRange = await helper.ts.getModifiableRange(srvMasterData);
    return await esi.impl.RemoteService(this, {
        PreOn: async function (oService) {
            oService.on('*', [TimeSheetClientSet, TimeSheetNonClientSet], async (oRequest, fNextHandler) => {
                oLog.info(oEvent.PreOn, oRequest, "BEGIN");
                const oHeaders = helper.getRequestHeaders(oRequest);
                oLog.info(oEvent.PreOn, oRequest, "Request Headers", { "x-onbehalfof-user": oHeaders["x-onbehalfof-user"], "x-show-all-status": oHeaders["x-show-all-status"] });
                oLog.warn(oEvent.PreOn, oRequest, "HD", "user", oRequest.user);
                const sUserEmailAddress = helper.ts.getOnBehalfOfUserId(oRequest);
                if (!oRequest.PreOn)
                    oRequest.PreOn = {};
                const oEntityColumns = esi.service.getEntityColumns(oService, oRequest);
                oLog.info(oEvent.PreOn, oRequest, "Entity Columns", oEntityColumns);
                oRequest.PreOn.entity = {
                    columns: oEntityColumns
                };
                const srvUser = await esi.connect.to("LocalService.UserExtensionService");
                const oUser = await srvUser.tx({
                    user: {
                        id: 'technicalUser',
                        roles: ['ADMIN']
                    }
                }).send('getUser', {
                    "params": {
                        "EmailAddress": sUserEmailAddress
                    }
                });
                oLog.info(oEvent.PreOn, oRequest, "Logged In User", oUser);
                oLog.warn(oEvent.PreOn, oRequest, "HD", "user", oRequest.user);
                if (!oUser || !Array.isArray(oUser) || oUser?.length != 1) {
                    oLog.error(oEvent.PreOn, oRequest, "ERROR", `Issue in Logged in User(${sUserEmailAddress}) profile`);
                    oRequest.reject(403, `Logged in user(${sUserEmailAddress}) does not exist!!!`);
                }

                if (oUser?.[0]?.ServiceCostLevel > 20) {
                    oLog.error(oEvent.PreOn, oRequest, "ERROR", `Issue in Logged in User(${sUserEmailAddress}) profile. Service Cost Level will not be allowed greater than 20`);
                    oRequest.reject(`Logged in user(${sUserEmailAddress}) Service Cost Level is incorrect, please contact your local HR department.`);
                }

                Object.assign(oRequest.PreOn, { User: utils.array.toDisArray(oUser) });
                oLog.info(oEvent.PreOn, oRequest, "END", "User", oRequest.PreOn.User);
                return await fNextHandler();
            });

            oService.on('READ', [TimeSheetClientSet, TimeSheetNonClientSet], async (oRequest, fNextHandler) => {
                oLog.info(oEvent.PreOn, oRequest, "BEGIN", oRequest.target.name, oRequest.query.SELECT.columns);
                const oHeaders = oRequest?.http?.req?.headers || oRequest.headers || {};
                const bShowAllStatus = oHeaders["x-show-all-status"] === "true" || false;
                oLog.info(oEvent.PreOn, oRequest, "x-show-all-status", bShowAllStatus);
                let oColumns = [];
                if (!oRequest.PreOn)
                    oRequest.PreOn = {};
                Object.assign(oRequest.PreOn, {
                    SELECT: {
                        columns: [],
                        where: []
                    },
                    IDEmpty: false,
                    WithKey: false
                });
                if (!oRequest.query.SELECT?.columns || oRequest.query.SELECT.columns[0] === '*') {
                    oColumns = [
                        { ref: ['YY1_TimeSheetKey_TIM'], as: 'ID' },
                        { ref: ['PersonWorkAgreementExternalID'] },
                        { ref: ['CompanyCode'] },
                        { ref: ['TimeSheetRecord'] },
                        { ref: ['TimeSheetDate'] },
                        { ref: ['YY1_UnitWholeNr_TIM'], as: 'TimeSheetUnit' },
                        { ref: ['TimeSheetStatus'], as: 'TimeSheetStatus' }
                    ];
                    switch (oRequest.target.name) {
                        case 'TimeSheetDataService.TimeSheetClientSet':
                            oColumns.push(
                                { ref: ['YY1_CustomerKey_TIM'], as: 'Customer' },
                                { ref: ['YY1_CustomerProjectKey_TIM'], as: 'ProjectID' },
                                { ref: ['YY1_WBSKey_TIM'], as: 'WorkPackageID' }
                            );
                            oRequest.PreOn.SELECT.columns.push(
                                { ref: ['TimeSheetDataFields_WorkItem'], as: 'WorkItem' },
                                { ref: ['TimeSheetDataFields_BillingControlCategory'], as: 'BillingControlCategory' }
                            );
                            break;
                        case 'TimeSheetDataService.TimeSheetNonClientSet':
                            oColumns.push(
                                { ref: ['YY1_WBSElement_TIM'], as: 'GroupName' }
                            );
                            oRequest.PreOn.SELECT.columns.push(
                                { ref: ['TimeSheetDataFields_TimeSheetTaskType'], as: 'TimeSheetTaskType' }
                            );
                            break;
                    }
                    oRequest.PreOn.SELECT.columns.push({ ref: ['TimeSheetDataFields_TimeSheetNote'], as: 'TimeSheetNote' });
                    if (oRequest.query.SELECT.columns) {
                        oColumns.push(...oRequest.query.SELECT.columns.filter(oItem => oItem !== "*"), { ref: ['YY1_Customer_TIM'], as: 'CustomerName' });
                    }
                    oRequest.query.SELECT.columns = oColumns;
                }
                oRequest.PreOn.SELECT.columns.push(...oRequest.query.SELECT.columns);
                oRequest.query.SELECT.columns = oRequest.query.SELECT.columns.filter(oItem => !(['HasActiveEntity', 'HasDraftEntity', 'IsActiveEntity', 'DraftAdministrativeData', 'TimeSheetNote', 'BillingControlCategory', 'WorkItem', 'TimeSheetTaskType'].includes(oItem.ref[0])));
                oRequest.query.SELECT.columns.push(
                    { ref: ["TimeSheetDataFields"] },
                    { ref: ['YY1_TimeSheetKey_TIM'], as: 'ID' },
                    { ref: ['PersonWorkAgreementExternalID'] },
                    { ref: ['CompanyCode'] },
                    { ref: ['YY1_PredecessorKey_TIM'], as: 'PredecessorID' },
                    { ref: ['TimeSheetPredecessorRecord'] },
                    { ref: ['TimeSheetRecord'] },
                    { ref: ['YY1_Customer_TIM'], as: 'CustomerName' }
                );
                oLog.warn(oEvent.PreOn, oRequest, "Step1", oRequest.query.SELECT.columns);
                oRequest.query.SELECT.columns = utils.array.unique(oRequest.query.SELECT.columns);
                oLog.warn(oEvent.PreOn, oRequest, "Step2", oRequest.query.SELECT.columns);
                const convertWhere = (/** @type {object} */oIDWhere) => {
                    return esi.query.SELECT.where.convert(oIDWhere, ["ID", "YY1_TimeSheetKey_TIM"]);
                };
                if (oRequest.query.SELECT.from.ref[0].where) {
                    const oIDWhere = convertWhere(oRequest.query.SELECT.from.ref[0].where);
                    oRequest.PreOn.WithKey = true;
                    if (oIDWhere.length == 0) {
                        oRequest.PreOn.IDEmpty = true;
                    } else {
                        oRequest.query.SELECT.from.ref[0].where = oIDWhere;
                    }
                    if (!bShowAllStatus && oRequest.query.SELECT?.where && Array.isArray(oRequest.query.SELECT?.where)) {
                        const oTimeSheetStatusFilter = oRequest.query.SELECT?.where.find((oItem) => (typeof oItem == "object" && oItem?.xpr && Array.isArray(oItem?.xpr) && oItem?.xpr.length == 3 && oItem?.xpr[0]?.ref[0] == 'TimeSheetStatus' && oItem?.xpr[1] == "=" && oItem?.xpr[2]?.val));
                        if (oTimeSheetStatusFilter)
                            oRequest.PreOn.FilterOnStatus = oTimeSheetStatusFilter.xpr[2].val;
                    }
                } else if (oRequest.query.SELECT.where) {
                    let oWhereClause = oRequest.query.SELECT.where;
                    const oWhere = esi.query.SELECT.where.toANDArray(oWhereClause, true);
                    oLog.info(oEvent.PreOn, oRequest, "1-", oWhere);
                    const oIDWhere = oWhere.find((oItem) => (oItem[0]?.ref && (oItem[0].ref[0] === "ID" || oItem[0].ref[0] === "YY1_TimeSheetKey_TIM"))) || [];
                    const oIDtransformedWhere = convertWhere(oIDWhere);
                    oLog.info(oEvent.PreOn, oRequest, "2-", oIDtransformedWhere);
                    const oWhereWithoutID = oWhere.filter((oItem) => !(oItem[0]?.ref && (oItem[0].ref[0] === "ID" || oItem[0].ref[0] === "YY1_TimeSheetKey_TIM")));
                    oLog.info(oEvent.PreOn, oRequest, "3-", oWhereWithoutID);
                    if (bShowAllStatus && oWhereWithoutID && Array.isArray(oWhereWithoutID)) {
                        oWhereClause = utils.array.toInterleavedArray(oWhereWithoutID.filter((oItem) => (typeof oItem == "object" && oItem?.xpr && Array.isArray(oItem?.xpr) && oItem?.xpr.length == 3 && oItem?.xpr[0]?.ref[0] == 'TimeSheetStatus' && oItem?.xpr[1] == "=" && oItem?.xpr[2]?.val)), 'and').flat(1);
                    } else {
                        oWhereClause = utils.array.toInterleavedArray(oWhereWithoutID, 'and').flat(1);
                    }
                    oLog.info(oEvent.PreOn, oRequest, "4-", oWhereClause);
                    if (!Array.isArray(oWhereClause)) {
                        oWhereClause = [];
                    } else if (oWhereClause.length > 0) {
                        oWhereClause.push("and");
                    }
                    if (oIDtransformedWhere.length > 0)
                        oWhereClause.push(...oIDtransformedWhere);
                    oLog.info(oEvent.PreOn, oRequest, "User", oRequest.PreOn.User);
                    if (oWhereClause.length > 0)
                        oWhereClause.push('and');
                    oWhereClause.push({ ref: ["PersonWorkAgreementExternalID"] }, "=", { val: oRequest.PreOn.User.PersonExternalID });
                    oRequest.query.SELECT.where = utils.array.toInterleavedArray(utils.array.unique(utils.array.toArray(esi.query.SELECT.where.toANDArray(oWhereClause))), 'and').flat(1);
                    oLog.trace(oEvent.PreOn, oRequest, "Query", oRequest.query.SELECT.where);
                    if (oRequest.query.SELECT.where.length == 0) {
                        oRequest.PreOn.IDEmpty = true;
                    }
                } else {
                    oRequest.query.SELECT.where = [];
                    oLog.info(oEvent.PreOn, oRequest, "User", oRequest.PreOn.User);
                    oRequest.query.SELECT.where.push({ ref: ["PersonWorkAgreementExternalID"] }, "=", { val: oRequest.PreOn.User.PersonExternalID });
                }
                oLog.info(oEvent.PreOn, oRequest, "END", oRequest.query.SELECT);
                return await fNextHandler();
            });
        },

        PostOn: async function (oService) {
            const get = async (sMode, oRequest) => {
                oLog.info(oEvent.PostOn, oRequest, "[get:" + sMode + "] - BEGIN", oRequest?.data);
                if (sMode == 'D' && !oRequest?.data?.["ID"]) {
                    oRequest.data.ID = esi.query.DELETE.getKeyPropertyValueByName(oRequest, "ID");
                } 
                if (sMode != 'C' && !oRequest?.data?.["ID"]) {
                    oLog.error(oEvent.PostOn, oRequest, "[get:" + sMode + "] TimeSheet ID is mandatory");
                    oRequest.reject(400, 'TimeSheet ID is mandatory');
                }
                const oID = uuid.inverse(oRequest.data.ID);
                if (sMode != 'C' && (!oID || !oID?.["CompanyCode"] || !oID?.["PersonWorkAgreementExternalID"] || !oID?.["TimeSheetRecord"])) {
                    oLog.error(oEvent.PostOn, oRequest, "[get:" + sMode + "] TimeSheet ID", oRequest.data.ID, "is Invalid!!!");
                    oRequest.reject(400, 'TimeSheet ID ' + oRequest.data.ID + ' is invalid!!!');
                }
                if (sMode != 'C' && (oID.CompanyCode !== oRequest.PreOn.User.CompanyCode || oID.PersonWorkAgreementExternalID !== oRequest.PreOn.User.PersonWorkAgreementExternalID)) {
                    oLog.error(oEvent.PostOn, oRequest, "[get:" + sMode + "] TimeSheet ID does not belongs to", oRequest.PreOn.User.EmailAddress);
                    oRequest.reject(400, 'TimeSheet ID does not belongs to ' + oRequest.PreOn.User.EmailAddress);
                }
                if (sMode != 'D' && !oRequest?.data?.["TimeSheetDate"]) {
                    oLog.error(oEvent.PostOn, oRequest, "[get:" + sMode + "] TimeSheet Date is mandatory");
                    oRequest.reject(400, 'TimeSheet Date is mandatory');
                }
                if (sMode != 'D' && !utils.date.isValid(oRequest.data.TimeSheetDate)) {
                    oLog.error(oEvent.PostOn, oRequest, "[get:" + sMode + "] TimeSheet Date is not valid");
                    oRequest.reject(400, 'TimeSheet Date is not valid');
                }
                oLog.info(oEvent.PostOn, oRequest, "[get:" + sMode + "] oRequest.data :", oRequest.data);
                oLog.info(oEvent.PostOn, oRequest, "[get:" + sMode + "] User :", oRequest.PreOn.User);

                let dEntryDate = undefined;

                if (!oRequest?.data?.["TimeSheetDate"]) {
                    const aResult = await oService.run(SELECT.from(oRequest?.target?.name).where({ ID: oRequest?.data?.ID }).columns("TimeSheetDate"));
                    dEntryDate = aResult?.[0]?.TimeSheetDate ? new Date(aResult[0].TimeSheetDate) : undefined;
                } else {
                    dEntryDate = new Date(oRequest.data.TimeSheetDate);
                }

                const bEditableFlag = helper.ts.isAppEditable(dEntryDate, oModifiableRange);

                if (!bEditableFlag) {
                    return oRequest.reject(400, `Please select a date in the allowed time range, You can only create, edit or delete entries between ${oModifiableRange.Low.toISOString().slice(0, 10)} and ${oModifiableRange.High.toISOString().slice(0, 10)}.`);
